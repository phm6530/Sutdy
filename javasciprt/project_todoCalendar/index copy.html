<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link rel="stylesheet" href="./reset.css">
    <link rel="stylesheet" href="./app.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    
    <header id="header"></header>
    
    <div class="container">
        <!-- 타이머 -->
        <div class="timer"></div>
        <div id="waether">
            <div class="card-wrap" onmousemove="tilt(event)" onmouseleave="resetTilt(this)"></div>

            <div class="swiper-container"></div>
        </div>

        <div class="wrap">
            <!-- 캘린더 -->
            <div id="myCalendar" class="myCalendar"></div>
            <!-- TodoList -->
            <div class="wrap_list">
                <div class="listArea">
                    <div id="todoList"></div>
                </div>
            </div>
        </div>
    </div>
    <footer id="footer">
    </footer>


</body>
<!-- script -->
<script src="./script.js"></script>
<script src="./calendar.js"></script>
<script src="./todoList.js"></script>

<!-- lib -->
<script src="./lib/swiper.bundle.js"></script>
<link rel="stylesheet" href="./lib/swiper-bundle.css" />
<script>

const weatherIcon = (key) => {
    return `img/icon/${key}.png`;
};

// 카드생성
function addCard(country , city ,firstData , allData){
    const cardWrap = document.querySelector('.card-wrap');
    const card = document.createElement('div');
    card.classList.add('card');
    const cardBg = createAndAppend(card, 'div', '', 'card-bg');
    const cardInfo = createAndAppend(card, 'div', '', 'card-info');

    const day = new Date().getDay();
    const icon = firstData.weather[0].main;
    

    // console.log(fullTextDays[day]);
    
    const cardDate = firstData.dt_txt.split(" ")[0].split("-");
    let  allDataHTML = '';
    allDataHTML += '<div class="datalist">'
    allData.forEach((e)=>{
        hour = e.dt_txt.split(' ')[1].slice(0,2)
        const formatHour = (hour.charAt(0) === '0') ? hour.charAt(1) + '시' : hour + '시';
        allDataHTML += '<div class="cardDatalist">';
        allDataHTML += `<img class='weather_list_icon' src='./${weatherIcon(e.weather[0].main)}'alt='${e.weather[0].main}' >`;
        allDataHTML += `${formatHour}`;
        allDataHTML += `<div class='math'>${Math.round(e.main.temp - 273.15)} <span>°C</span></div>`;
        // allDataHTML += e.weather[0].main + '메인';
        // allDataHTML += e.main.humidity + '습도';
        // allDataHTML += e.weather[0].main, '날씨 메인';
        // allDataHTML += e.weather[0].description, '하늘 맑은지 보는거';
        // allDataHTML += e.weather[0].icon, '딱히 안쓸듯';
        // allDataHTML += e.wind.speed, '풍속';
        allDataHTML += '</div>';
    });
    allDataHTML += '</div>'
   
    // cardAlldata.innerHTML = allDataHTML;
    
    let html = '';
    html += `<div class='card_day'>${fullTextDays[day]}</div>`
    html += `<div class='card_date'>${cardDate[2]} <span>${textMonth[cardDate[1] - 1].slice(0,3)}</span> ${cardDate[0]}</div>`;

 
    
    const iconArea = createAndAppend(cardInfo, 'p', '', 'iconArea');
    const todayMatch = createAndAppend(cardInfo, 'div','' ,'todayMatch')
    const cardAlldata = createAndAppend(cardInfo, 'div', '', 'cardAlldata');
    iconArea.innerHTML = html;
    cardAlldata.innerHTML = allDataHTML;
    todayMatch.innerHTML += `<img class='weather_icon' src='./${weatherIcon(firstData.weather[0].main)}'alt='${firstData.weather[0].main}' >`;
    todayMatch.innerHTML += `<div class='temp-align'><span>${Math.round(firstData.main.temp - 273.15)}°C</span><span>${city} .${country}</span></div>`;
    todayMatch.innerHTML += ``;
    // p.textContent = 
    // console.log('받은 데이터 :', firstData);
    // console.log(thisMonth);
    // console.log(textDays);
    
    cardBg.style.backgroundImage = 'url(./img/weather/november.jpg)';
    cardWrap.appendChild(card);
}


// console.log(thisClick());

function swiperHandler(country, city, weatherData){
    const targetSwiper =  document.querySelector('.swiper-container');
    const swiperWrapper = createDiv3(1,'swiper-wrapper');
    
    const currentDate = new Date();
    const koreaTime = new Date(currentDate.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    
    // const todayThistime = new Date().getHours() * 60   + new Date().getMinutes() ;
    const todayThistime = new Date().getHours();
    // console.log(todayThistime);
    
    // console.log(todayThistime);
    // console.log(today);
    // console.log(weatherData[0].dt_txt.split(' ')[0] === today);

    const todayArr = weatherData.filter((e)=>{
        return e.dt_txt.split(' ')[0] === today;
    });
    // console.log(todayTime);
    // console.log(todayThistime);
    
    const CardData = [];
    todayArr.forEach((arr, idx)=>{
        const hours = arr.dt_txt.split(" ")[1].slice(0,2);
        if(CardData.length === 0 ||  hours < todayThistime){
            CardData.push(arr);
        }
        // console.log(arr);
    });
    console.log(todayArr);
    addCard(country , city, CardData[CardData.length - 1] ,todayArr);

    // 가까운시간 가져오기..
    // let testArr = {};
    // todayArr.forEach((e)=>{
    //     const thisday = e.dt_txt;
    //     const weatherTime = new Date(thisday).getHours() * 60 + new Date(thisday).getMinutes();
    //     const timeddd = Math.abs(weatherTime - todayThistime);
        
    //     if(Object.keys(testArr).length === 0 || timeddd < testArr.timeddd ){
    //             testArr = { array : e , timeddd : timeddd };
    //     }
    // });
    // console.log(testArr.array);
    
    
    // const firstSlide = createDiv3(1,'swiper-slide');
    // todayArr.forEach((e)=>{
    //         console.log(e);
    //         let firstHTML = '';
    //         firstHTML += '<div>';
    //         firstHTML += weatherIcon(e.weather[0].main);
    //         firstHTML += e.dt_txt + '/';
    //         firstHTML += Math.round(e.main.temp - 273.15)+ '온도';
    //         firstHTML += e.weather[0].main + '메인';
    //         firstHTML += e.main.humidity + '습도';
    //         firstHTML += e.weather[0].main, '날씨 메인';
    //         firstHTML += e.weather[0].description, '하늘 맑은지 보는거';
    //         firstHTML += e.weather[0].icon, '딱히 안쓸듯';
    //         firstHTML += e.wind.speed, '풍속';
    //         firstHTML += '<div>';
    //         firstSlide.innerHTML += firstHTML;
    // });
    // swiperWrapper.appendChild(firstSlide);

    // console.log(textClock(thisClick()));
    // const todayWether = weatherData.filter((e)=>{
    //     e.dt_txt ===  
    // });

    // console.log(todayWether);

        
    const slide = createDiv3(1,'swiper-slide');
    weatherData.forEach(e => {
           
            let HTML = '';
            HTML += weatherIcon(e.weather[0].main);
            HTML += e.dt_txt + '/';
            HTML += Math.round(e.main.temp - 273.15)+ '온도';
            HTML += e.weather[0].main + '메인<br>';
            HTML += e.main.humidity + '습도';
            HTML += e.weather[0].main, '날씨 메인';
            HTML += e.weather[0].description, '하늘 맑은지 보는거';
            HTML += e.weather[0].icon, '딱히 안쓸듯';
            HTML += e.wind.speed, '풍속';
            slide.innerHTML += HTML;
           
    });
    // swiperWrapper.appendChild(slide);
    targetSwiper.appendChild(swiperWrapper);
    const mySwiper = new Swiper('.swiper-container', {
        slidesPerView: 1, 
        spaceBetween: 10, 
        pagination: {
            el: '.swiper-pagination',
            clickable: true
        },
          // 슬라이드 효과 지정 ('slide', 'fade', 'cube', 'coverflow' 등)
        effect: 'fade',
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
    });
}






// console.log(time);
// console.log(time > 18 ? '밤' : '낮');

    // clear: 1,
    // clouds : 2,
    // drizzle : 3,
    // humidity : 4,
    // mist: 5,
    // rain : 6,
    // search : 7,
    // snow : 8,
    // wind : 9



const test = document.getElementById('waether');

const loadingText = createDiv(1, 'loading');
loadingText.classList.add('loadingDiv');
loadingText.textContent = 'Loading...';
test.appendChild(loadingText);


// 위치 정보 받기
navigator.geolocation.getCurrentPosition(async (position) => {
    const { latitude, longitude } = position.coords;
    const apiKey = '4ff4e9b9bb000db3b5905140478fd229';
    const apiURI = `https://api.openweathermap.org/data/2.5/forecast?lat=${latitude}&lon=${longitude}&appid=${apiKey}`;            

    const fetchData = async () =>{
    fetch(apiURI)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('에러 났네');
            }
        })
        .then(data => {
            // console.log(data);
            const cityName = data.city.name;
            const country = data.city.country;
            // const currentDateTime = new Date().getDate();
            // const weatherResponse = data.list.filter(entry => {
            //     // API에서 받아온 시간 문자열을 Date 객체로 변환
            //     const forecastDateTime = new Date(entry.dt_txt).toISOString().split('T')[0].slice(-2);
            //     // console.log(forecastDateTime);
            //     return Number(forecastDateTime) >= currentDateTime; 
                
            // });
            const text = createDiv3(1, 'weatherWrap');
            test.removeChild(loadingText);
            test.appendChild(text);
            // console.log(data);
            swiperHandler(country , cityName, data.list);
        })
        .catch(error => {
            loadingText.textContent = error;
            console.error('Error fetching data:', error);
         
        });
    }
    
    fetchData();
    
});
// 여기서는 weatherPromise가 Promise 객체이므로, then()이나 catch()를 사용할 수 있습니다.

</script>
</html> 