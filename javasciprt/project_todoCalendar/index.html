<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar</title>
    <link rel="stylesheet" href="./reset.css">
    <link rel="stylesheet" href="./app.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
    
    <header id="header"></header>
    
    <div class="container">
        <!-- 타이머 -->
        <div class="timer"></div>
        <div id="waether">
            <div class="card-wrap" onmousemove="tilt(event)" onmouseleave="resetTilt(this)"></div>
            <div class="swiper-container"></div>
        </div>

        <div class="wrap">
            <!-- 캘린더 -->
            <div id="myCalendar" class="myCalendar"></div>
            <!-- TodoList -->
            <div class="wrap_list">
                <div class="listArea">
                    <div id="todoList"></div>
                </div>
            </div>
        </div>
    </div>
    <footer id="footer">
    </footer>


</body>
<!-- script -->
<script src="./script.js"></script>
<script src="./calendar.js"></script>
<script src="./todoList.js"></script>

<!-- lib -->
<script src="./lib/swiper.bundle.js"></script>
<link rel="stylesheet" href="./lib/swiper-bundle.css" />
<script>

const weatherIcon = (key) => {
    return `img/icon/${key}.png`;
};

// 카드생성
function addCard(country , city ,firstData , allData){
    console.log(allData);
    const cardWrap = document.querySelector('.card-wrap');
    const card = document.createElement('div');
    card.classList.add('card');
    const cardBg = createAndAppend(card, 'div', '', 'card-bg');
    const cardInfo = createAndAppend(card, 'div', '', 'card-info');

    const day = new Date().getDay();
    const icon = firstData.weather[0].main;
    const cardDate = firstData.dt_txt.split(" ")[0].split("-");
    
    let html = '';
    html += `<div class='card_day'>${cardDate[2]} <span>${textMonth[cardDate[1] - 1].slice(0,3)}</span> ${cardDate[0]}</div>`
    html += `<div class='card_date'>${fullTextDays[day]}</div>`;

    const iconArea = createAndAppend(cardInfo, 'p', '', 'iconArea');
    const todayMatch = createAndAppend(cardInfo, 'div','' ,'todayMatch')

    iconArea.innerHTML = html;
    todayMatch.innerHTML += `<div class='temp-align'><img class='weather_icon' src='${weatherIcon(firstData.weather[0].main)}'alt='${firstData.weather[0].main}' ><span>${Math.round(firstData.main.temp - 273.15)}<span>°</span></span></div>`;
    todayMatch.innerHTML += `<span class='city'>${city} .${country}</span>`;
    todayMatch.innerHTML += `</div>`;
    cardWrap.appendChild(card);
}

function addSlider(arr){
    let firstHTML = '';
    arr.forEach((e)=>{
        const hourFormat = e.dt_txt.split(" ")[1].slice(0,2);
        const resultHour = hourFormat.charAt(0) === '0' ? hourFormat.charAt(1) : hourFormat;
        firstHTML += '<div class="slide-wrap">';
        firstHTML += `<img src='${weatherIcon(e.weather[0].main)}' alt='${e.weather[0].main}'>`;
        firstHTML +=  resultHour + '시'
        firstHTML += Math.round(e.main.temp - 273.15)+ '°';
        // firstHTML += e.main.humidity + '습도';
        firstHTML += e.weather[0].main, '날씨 메인';
        // firstHTML += e.weather[0].description, '하늘 맑은지 보는거';
        // firstHTML += e.weather[0].icon, '딱히 안쓸듯';
        firstHTML += e.wind.speed, '풍속';
        firstHTML += '<div>';
    });
    return firstHTML;
}

function btnWeatherday(days){   
    const swiperContainer = document.querySelector('.swiper-container');
    const btnArea = createAndAppend(swiperContainer, 'div', '', 'btnArea');

    days.forEach((e,idx) => {
        const textday = new Date(e).getDay();
        const btnDiv = document.createElement('div');
        btnDiv.setAttribute('data-set', idx);
        idx === 0 ? btnDiv.classList.add('WeatherBtn' , 'active') : btnDiv.classList.add('WeatherBtn');
        btnDiv.textContent = textDays[textday];
        btnArea.appendChild(btnDiv);
    });
}
 
function swiperHandler(country, city, weatherData , resultKeys){
    const targetSwiper =  document.querySelector('.swiper-container');
    const swiperWrapper = createDiv3(1,'swiper-wrapper');
    
    const currentDate = new Date();
    const koreaTime = new Date(currentDate.getTime() + (9 * 60 * 60 * 1000));
    const today = koreaTime.toISOString().split('T')[0];
    // const todayThistime = new Date().getHours() * 60   + new Date().getMinutes() ;
    const todayThistime = new Date().getHours();


    const CardData = [];
    weatherData[today].forEach((arr, idx)=>{
        const times = arr.dt_txt.split(" ")[1].slice(0,2);
        const hours = (times.charAt(0) === '0') ? parseInt(times.charAt(1)) : parseInt(times);
        // console.log('시간 :',hours);
        // console.log('지금시간 : ',todayThistime);
        if(CardData.length === 0 ||  hours <= todayThistime){
            CardData.push(arr);
        }
        // console.log(arr);
    });

    // 오늘데이터만 넘기는 카드 생성 또고쳐야할듯
    
    // btnWeatherday(weatherData);
    
    
    resultKeys.forEach(e=>{
        const SlideContents = createDiv3(1,'swiper-slide');
        SlideContents.innerHTML += addSlider(weatherData[e]);
        swiperWrapper.appendChild(SlideContents);
    });
    
    
    targetSwiper.appendChild(swiperWrapper);

    const mySwiper = new Swiper('.swiper-container', {
        slidesPerView: 1,
        spaceBetween: 10,
        pagination: {
            el: '.swiper-pagination',
            clickable: true
        },
        effect: 'fade',
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
    });

    // btnClick 함수에 mySwiper를 전달하여 사용할 수 있도록 함
    
    btnClick(resultKeys, mySwiper);
    addCard( country , city, CardData[CardData.length - 1] ,weatherData);
}



const test = document.getElementById('waether');

const loadingText = createDiv(1, 'loading');
loadingText.classList.add('loadingDiv');
loadingText.textContent = 'Loading...';
test.appendChild(loadingText);

function btnClick(data, swiper) {
    const target = document.querySelectorAll('.WeatherBtn');
    target.forEach((e) => {
        e.addEventListener('click', () => {
            target.forEach((del)=> del.classList.remove('active'));
            e.classList.add('active');
            const idx = e.getAttribute(['data-set']);
            swiper.slideTo(idx);
            // addCard( country , city, CardData[CardData.length - 1] ,weatherData);
        });
    });
}

// 위치 정보 받기
navigator.geolocation.getCurrentPosition(async (position) => {
    const { latitude, longitude } = position.coords;
    const apiKey = '4ff4e9b9bb000db3b5905140478fd229';
    const apiURI = `https://api.openweathermap.org/data/2.5/forecast?lat=${latitude}&lon=${longitude}&appid=${apiKey}`;            

    const fetchData = async () =>{
    fetch(apiURI)
        .then(response => {
            if (response.ok) {
                return response.json();
            } else {
                throw new Error('에러 났네');
            }
        })
        .then(data => {
            const cityName = data.city.name;
            const country = data.city.country;
            const text = createDiv3(1, 'weatherWrap');
            test.removeChild(loadingText);
            test.appendChild(text);

            // 일별 객체배열 생성
            // const resultArr = (arr)=>{
            //     const weatherArr = {city: arr.city.country , country : arr.city.name};
            //     console.log(arr.list);
            //     // console.log(arr.key);
            //     arr.list.forEach((e)=>{
            //         const date = e.dt_txt.split(" ")[0];
            //         if(!weatherArr[date]){
            //             weatherArr[date] = [];
            //         }
            //         weatherArr[date].push(e);
            //     });
            //     console.log(weatherArr);
     
            //     return weatherArr;
            // }
            // console.log(resultArr(data));
           const resultArr = data.list.reduce((arr , val) =>{
                    const data =  val.dt_txt.split(" ")[0];
                    arr[data] = arr[data] || [];
                    arr[data].push(val);
                    return arr
            },{});
            // 일 생성
            const resultKeys = Object.keys(resultArr);
            btnWeatherday(resultKeys);
            swiperHandler(country , cityName , resultArr , resultKeys );
            // addCard( country , cityName , CardData[CardData.length - 1] ,weatherData);
        })
        .catch(error => {
            loadingText.textContent = error;
            console.error('Error fetching data:', error);
        });
    }
    fetchData();
});

</script>
</html> 